
name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Use Node.js 20.x
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'

      - name: Install pnpm
        run: npm install -g pnpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Lint
        run: pnpm exec eslint . --ext .ts,.tsx,.js,.jsx

      - name: Format check
        name: CI

        on:
          push:
            branches:
              - main
              - release/**
          pull_request:
            branches:
              - main

        concurrency:
          group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
          cancel-in-progress: true

        jobs:
          quality:
            name: ${{ matrix.target }}
            runs-on: ubuntu-latest
            strategy:
              fail-fast: false
              matrix:
                target: [lint, typecheck, test]
            steps:
              - name: Checkout
                uses: actions/checkout@v4

              - name: Setup pnpm
                uses: pnpm/action-setup@v4
                with:
                  version: 10

              - name: Setup Node
                uses: actions/setup-node@v4
                with:
                  node-version: 22
                  cache: pnpm

              - name: Install
                run: pnpm install --frozen-lockfile

              - name: Run ${{ matrix.target }}
                run: |
                  if [ "${{ matrix.target }}" = "lint" ]; then pnpm run lint; fi
                  if [ "${{ matrix.target }}" = "typecheck" ]; then pnpm run typecheck; fi
                  if [ "${{ matrix.target }}" = "test" ]; then pnpm run test; fi

          build:
            runs-on: ubuntu-latest
            needs: quality
            steps:
              - name: Checkout
                uses: actions/checkout@v4

              - name: Setup pnpm
                uses: pnpm/action-setup@v4
                with:
                  version: 10

              - name: Setup Node
                uses: actions/setup-node@v4
                with:
                  node-version: 22
                  cache: pnpm

              - name: Install
                run: pnpm install --frozen-lockfile

              - name: Build
                run: pnpm run build

          deploy-vercel:
            name: Deploy to Vercel
            needs: build
            runs-on: ubuntu-latest
            if: github.ref == 'refs/heads/main' && github.event_name == 'push'
            steps:
              - name: Checkout
                uses: actions/checkout@v4

              - name: Setup pnpm
                uses: pnpm/action-setup@v4
                with:
                  version: 10

              - name: Setup Node
                uses: actions/setup-node@v4
                with:
                  node-version: 22
                  cache: pnpm

              - name: Install
                run: pnpm install --frozen-lockfile

              - name: Deploy to Vercel
                uses: amondnet/vercel-action@v25
                with:
                  vercel-token: ${{ secrets.VERCEL_TOKEN }}
                  vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
                  vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
                  working-directory: .
                  prod: true
                env:
                  VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}

          deploy-railway:
            name: Deploy to Railway
            needs: build
            runs-on: ubuntu-latest
            if: github.ref == 'refs/heads/main' && github.event_name == 'push'
            steps:
              - name: Checkout
                uses: actions/checkout@v4

              - name: Install Railway CLI
                run: npm install -g railway

              - name: Deploy to Railway
                run: railway up --service=server
                env:
                  RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}